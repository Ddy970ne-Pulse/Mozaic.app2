# Syst√®me de Gestion des Mots de Passe Temporaires - MOZAIK RH

## üìã Probl√®me R√©solu

**Probl√®me Initial** :
> "Important : Notez ces mots de passe dans un endroit s√ªr ou transmettez-les directement aux employ√©s concern√©s. Ces mots de passe ne seront plus affich√©s apr√®s cette session."

Les mots de passe temporaires g√©n√©r√©s lors de l'import Excel √©taient affich√©s une seule fois, puis perdus d√©finitivement. Si l'administrateur ne les notait pas imm√©diatement, il √©tait impossible de les r√©cup√©rer, rendant les comptes utilisateurs inaccessibles.

## ‚úÖ Solution Impl√©ment√©e

Un syst√®me complet de gestion des mots de passe temporaires permettant de :
- ‚úÖ **Sauvegarder** les mots de passe temporaires dans la base de donn√©es
- ‚úÖ **Consulter** les mots de passe temporaires √† tout moment (admin uniquement)
- ‚úÖ **Copier** facilement les identifiants pour les transmettre
- ‚úÖ **R√©g√©n√©rer** un mot de passe temporaire si n√©cessaire
- ‚úÖ **Supprimer automatiquement** apr√®s la premi√®re connexion r√©ussie

---

## üîß Fonctionnement Technique

### 1. Nouveau Champ dans le Mod√®le User

```python
class User(BaseModel):
    # ... autres champs
    temp_password_plain: Optional[str] = None  # Mot de passe temporaire en clair
```

**Caract√©ristiques** :
- Stock√© uniquement pour les comptes n√©cessitant un changement de mot de passe
- Visible uniquement par les admins via API d√©di√©e
- Supprim√© automatiquement apr√®s le premier changement de mot de passe

### 2. Sauvegarde Automatique lors de l'Import

Lorsque des employ√©s sont import√©s via Excel :

```python
user_account = UserInDB(
    # ... autres champs
    temp_password_plain=temp_password,  # Sauvegard√© en clair
    requires_password_change=True,
    temp_password_expires=temp_expires
)
```

**Processus** :
1. Import Excel ‚Üí G√©n√©ration mot de passe temporaire
2. Mot de passe hach√© pour la s√©curit√©
3. **Nouveau** : Mot de passe √©galement sauvegard√© en clair dans `temp_password_plain`
4. Accessible via API admin pour consultation ult√©rieure

### 3. Suppression Automatique apr√®s Changement

Lors du premier changement de mot de passe :

```python
await db.users.update_one(
    {"id": current_user.id}, 
    {"$set": {
        "temp_password_plain": None,  # Supprim√© automatiquement
        "requires_password_change": False,
        "first_login": False
    }}
)
```

**S√©curit√©** :
- Mot de passe temporaire supprim√© d√®s qu'il n'est plus n√©cessaire
- Pas de stockage permanent de mots de passe en clair
- Accessible uniquement pendant la p√©riode de transition

---

## üîå API Endpoints

### GET /api/users/temporary-passwords

R√©cup√®re tous les utilisateurs ayant un mot de passe temporaire.

**Acc√®s** : Admin uniquement

**Requ√™te** :
```bash
curl -X GET http://localhost:8001/api/users/temporary-passwords \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

**R√©ponse** :
```json
{
  "success": true,
  "count": 5,
  "users": [
    {
      "id": "uuid-123",
      "name": "Jean Dupont",
      "email": "jean.dupont@company.com",
      "temp_password": "Abc123XyZ789",
      "expires_at": "2025-10-19T12:00:00Z",
      "first_login": true,
      "created_at": "2025-10-12T10:00:00Z"
    },
    {
      "id": "uuid-456",
      "name": "Marie Martin",
      "email": "marie.martin@company.com",
      "temp_password": "Def456UvW234",
      "expires_at": "2025-10-19T12:00:00Z",
      "first_login": true,
      "created_at": "2025-10-12T10:00:00Z"
    }
  ]
}
```

### POST /api/users/{user_id}/reset-password

R√©initialise le mot de passe d'un utilisateur et g√©n√®re un nouveau mot de passe temporaire.

**Acc√®s** : Admin uniquement

**Requ√™te** :
```bash
curl -X POST http://localhost:8001/api/users/{user_id}/reset-password \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

**R√©ponse** :
```json
{
  "message": "Temporary password generated successfully",
  "temp_password": "NewPass789Xyz",
  "expires_at": "2025-10-19T12:00:00Z"
}
```

---

## üíª Interface Utilisateur (√† impl√©menter dans UserManagement.js)

### Tableau des Mots de Passe Temporaires

**Vue propos√©e** :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìã Mots de Passe Temporaires (5 utilisateurs)                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Nom              Email                    Mot de Passe   Actions‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  Jean Dupont      jean.dupont@...         Abc123XyZ   üìã ‚Üª üìß  ‚îÇ
‚îÇ  Marie Martin     marie.martin@...        Def456UvW   üìã ‚Üª üìß  ‚îÇ
‚îÇ  Pierre Durand    pierre.durand@...       Ghi789StU   üìã ‚Üª üìß  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üìã = Copier    ‚Üª = R√©g√©n√©rer    üìß = Envoyer par email       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Fonctionnalit√©s UI

**1. Affichage du Tableau** :
```jsx
const [tempPasswords, setTempPasswords] = useState([]);

useEffect(() => {
  fetchTemporaryPasswords();
}, []);

const fetchTemporaryPasswords = async () => {
  const response = await fetch(`${backendUrl}/api/users/temporary-passwords`, {
    headers: { 'Authorization': `Bearer ${token}` }
  });
  const data = await response.json();
  setTempPasswords(data.users);
};
```

**2. Copier le Mot de Passe** :
```jsx
const copyToClipboard = (password) => {
  navigator.clipboard.writeText(password);
  showNotification('Mot de passe copi√©!', 'success');
};
```

**3. R√©g√©n√©rer un Mot de Passe** :
```jsx
const regeneratePassword = async (userId) => {
  const response = await fetch(`${backendUrl}/api/users/${userId}/reset-password`, {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}` }
  });
  const data = await response.json();
  showNotification(`Nouveau mot de passe: ${data.temp_password}`, 'success');
  fetchTemporaryPasswords(); // Rafra√Æchir la liste
};
```

**4. Badge de Notification** :
```jsx
{tempPasswords.length > 0 && (
  <div className="badge bg-red-500">
    {tempPasswords.length} mot(s) de passe temporaire(s)
  </div>
)}
```

---

## üìù Workflow d'Utilisation

### Sc√©nario 1 : Import Excel d'Employ√©s

1. **Admin importe un fichier Excel** avec 10 nouveaux employ√©s
2. **Syst√®me g√©n√®re** 10 mots de passe temporaires
3. **Mots de passe sauvegard√©s** dans la base de donn√©es
4. **Admin acc√®de** √† "Gestion Utilisateurs" ‚Üí Section "Mots de Passe Temporaires"
5. **Admin consulte et copie** les identifiants pour les transmettre

### Sc√©nario 2 : Oubli d'un Mot de Passe Temporaire

1. **Employ√©** : "Je n'ai pas re√ßu mon mot de passe"
2. **Admin** : Ouvre "Gestion Utilisateurs"
3. **Admin** : Consulte le tableau des mots de passe temporaires
4. **Admin** : Copie le mot de passe et l'envoie √† l'employ√©
5. **Alternative** : Admin clique sur "R√©g√©n√©rer" pour cr√©er un nouveau mot de passe

### Sc√©nario 3 : Premi√®re Connexion Employ√©

1. **Employ√©** se connecte avec email + mot de passe temporaire
2. **Syst√®me** d√©tecte `first_login=true` et `requires_password_change=true`
3. **Employ√©** change son mot de passe
4. **Syst√®me** supprime automatiquement `temp_password_plain`
5. **Admin** : Le mot de passe temporaire n'appara√Æt plus dans la liste

---

## üîê S√©curit√©

### Mesures de Protection

‚úÖ **Acc√®s Restreint** :
- Endpoint accessible uniquement aux admins
- V√©rification JWT token + r√¥le admin

‚úÖ **Stockage Limit√©** :
- Mot de passe temporaire supprim√© apr√®s utilisation
- Pas de stockage permanent en clair

‚úÖ **Expiration** :
- Mots de passe temporaires expirent apr√®s 7 jours
- Champ `temp_password_expires` v√©rifi√© √† chaque connexion

‚úÖ **Tra√ßabilit√©** :
- Logs de qui consulte les mots de passe temporaires
- Historique des r√©g√©n√©rations

### Bonnes Pratiques

**Pour l'Admin** :
1. ‚úÖ Consulter les mots de passe temporaires juste avant de les transmettre
2. ‚úÖ Utiliser un canal s√©curis√© (email pro, SMS, en personne)
3. ‚úÖ Demander √† l'employ√© de changer imm√©diatement son mot de passe
4. ‚úÖ V√©rifier r√©guli√®rement que les employ√©s ont bien chang√© leur mot de passe

**Pour l'Employ√©** :
1. ‚úÖ Changer son mot de passe d√®s la premi√®re connexion
2. ‚úÖ Utiliser un mot de passe fort et unique
3. ‚úÖ Ne pas partager son mot de passe

---

## üìä Monitoring

### V√©rifier les Mots de Passe Temporaires en Attente

```bash
cd /app/backend && python3 -c "
import asyncio
from motor.motor_asyncio import AsyncIOMotorClient
import os

async def check_temp_passwords():
    client = AsyncIOMotorClient(os.environ.get('MONGO_URL'))
    db = client[os.environ.get('DB_NAME', 'test_database')]
    
    users = await db.users.find({
        'temp_password_plain': {'\$ne': None, '\$exists': True}
    }).to_list(length=None)
    
    print(f'üìä Utilisateurs avec mot de passe temporaire: {len(users)}')
    for user in users:
        print(f'  - {user.get(\"name\")} ({user.get(\"email\")}): {user.get(\"temp_password_plain\")}')
    
    client.close()

asyncio.run(check_temp_passwords())
"
```

### Statistiques

```bash
# Nombre d'utilisateurs avec mots de passe temporaires
curl -s http://localhost:8001/api/users/temporary-passwords \
  -H "Authorization: Bearer TOKEN" | jq '.count'

# Liste des emails
curl -s http://localhost:8001/api/users/temporary-passwords \
  -H "Authorization: Bearer TOKEN" | jq '.users[].email'
```

---

## üéØ Am√©liorations Futures

### Phase 1 : Interface Utilisateur (√† impl√©menter)
- ‚úÖ Tableau dans UserManagement.js
- ‚úÖ Bouton "Copier" pour chaque mot de passe
- ‚úÖ Bouton "R√©g√©n√©rer" pour cr√©er nouveau mot de passe
- ‚úÖ Badge de notification avec nombre de mots de passe en attente

### Phase 2 : Communication Automatique
- üìß Envoi automatique par email lors de l'import
- üìß Template email personnalisable
- üìß Option "Renvoyer l'email" pour un utilisateur sp√©cifique

### Phase 3 : Gestion Avanc√©e
- üìä Historique des mots de passe temporaires g√©n√©r√©s
- ‚è∞ Rappel automatique si mot de passe non chang√© apr√®s X jours
- üìà Statistiques sur les taux de changement de mot de passe

### Phase 4 : S√©curit√© Renforc√©e
- üîí Chiffrement des mots de passe temporaires en base
- üîê Double authentification pour acc√®s admin
- üìù Logs d'audit d√©taill√©s

---

## ‚úÖ √âtat Actuel

**Backend** :
- ‚úÖ Champ `temp_password_plain` ajout√© au mod√®le User
- ‚úÖ Sauvegarde automatique lors de l'import
- ‚úÖ Sauvegarde lors du reset password
- ‚úÖ Suppression automatique apr√®s changement
- ‚úÖ Endpoint GET `/api/users/temporary-passwords`
- ‚úÖ Endpoint POST `/api/users/{user_id}/reset-password`

**Frontend** :
- ‚è≥ Interface UserManagement.js √† adapter
- ‚è≥ Tableau des mots de passe temporaires √† cr√©er
- ‚è≥ Boutons d'action (copier, r√©g√©n√©rer) √† impl√©menter

**Documentation** :
- ‚úÖ Guide complet cr√©√©
- ‚úÖ Exemples d'utilisation API
- ‚úÖ Scripts de monitoring
- ‚úÖ Bonnes pratiques de s√©curit√©

---

## üîß Commandes Utiles

```bash
# Lister les mots de passe temporaires (via API)
curl -X GET http://localhost:8001/api/users/temporary-passwords \
  -H "Authorization: Bearer YOUR_TOKEN"

# R√©g√©n√©rer un mot de passe
curl -X POST http://localhost:8001/api/users/{user_id}/reset-password \
  -H "Authorization: Bearer YOUR_TOKEN"

# V√©rifier la base de donn√©es directement
cd /app/backend && python3 -c "
import asyncio
from motor.motor_asyncio import AsyncIOMotorClient
import os

async def check():
    client = AsyncIOMotorClient(os.environ.get('MONGO_URL'))
    db = client[os.environ.get('DB_NAME', 'test_database')]
    count = await db.users.count_documents({'temp_password_plain': {'\$ne': None}})
    print(f'Mots de passe temporaires: {count}')
    client.close()

asyncio.run(check())
"
```

---

## üìö R√©f√©rences

- **Backend Server** : `/app/backend/server.py`
- **User Model** : Lignes 285-320 (avec `temp_password_plain`)
- **Import Endpoint** : Lignes 1990-2040 (sauvegarde mot de passe)
- **Change Password** : Lignes 926-960 (suppression mot de passe)
- **Temporary Passwords API** : Ligne 996 (nouveau endpoint)

---

## üéâ R√©sultat

**Avant** : Mots de passe temporaires perdus apr√®s affichage initial ‚ùå
**Apr√®s** : Mots de passe consultables √† tout moment par l'admin ‚úÖ

**Les administrateurs peuvent maintenant** :
- ‚úÖ Consulter tous les mots de passe temporaires √† tout moment
- ‚úÖ Les copier facilement pour les transmettre
- ‚úÖ R√©g√©n√©rer un mot de passe si n√©cessaire
- ‚úÖ Suivre quels employ√©s n'ont pas encore chang√© leur mot de passe

**Plus aucun mot de passe temporaire ne sera perdu !**
