# üö® ANALYSE CRITIQUE : Gestion des Compteurs lors d'Interruption d'Absence

## Probl√®me Identifi√©

### Cas Concret
```
Employ√© : Jean Dupont
Action 1 : Pose 10 jours de CA du 01/01 au 14/01 (hors week-ends)
           ‚Üí Solde CA : 25 - 10 = 15 jours restants

Action 2 : Arr√™t maladie du 05/01 au 10/01 (6 jours calendaires = 4 jours ouvrables)
           ‚Üí Planning affiche correctement AM au lieu de CA

‚ùå PROBL√àME : Que devient le solde de CA ?
```

### Comportement Attendu selon la Loi

**Article L3141-5 du Code du Travail** :
> "La maladie survenant pendant les cong√©s pay√©s suspend l'ex√©cution du contrat de travail. 
> Les jours de cong√©s non pris du fait de la maladie doivent √™tre r√©int√©gr√©s au compteur."

**R√©sultat attendu** :
```
Solde initial CA    : 25 jours
CA pos√©s           : 10 jours (01/01-14/01)
AM du 05/01-10/01  : Interrompt 4 jours ouvrables de CA

Solde CA apr√®s     : 25 - 10 + 4 = 19 jours
                     ‚îî‚îÄ‚îÄ pos√©s  ‚îî‚îÄ‚îÄ r√©int√©gr√©s

CA r√©ellement pris : 6 jours (01-04/01 + 11-14/01)
AM comptabilis√©s   : 6 jours calendaires
```

---

## √âtat Actuel de l'Application

### ‚úÖ Ce qui fonctionne
1. **Affichage Planning** : AM remplace CA visuellement ‚úÖ
2. **Priorit√©s** : Logique de remplacement correcte ‚úÖ
3. **Console logs** : Trace des remplacements ‚úÖ

### ‚ùå Ce qui manque (CRITIQUE)

#### 1. Pas de Syst√®me de Compteurs Persistant
```javascript
// Actuellement inexistant dans le backend
{
  employee_id: "uuid",
  solde_ca: 25,        // ‚ùå N'existe pas
  solde_rtt: 12,       // ‚ùå N'existe pas
  solde_rec: 8,        // ‚ùå N'existe pas
  historique: []       // ‚ùå N'existe pas
}
```

#### 2. Pas de R√©int√©gration Automatique
Quand AM remplace CA :
- ‚ùå Les jours de CA ne sont PAS r√©int√©gr√©s au solde
- ‚ùå Le salari√© perd d√©finitivement ces jours
- ‚ùå Aucune trace de la r√©int√©gration

#### 3. Pas de Notification
- ‚ùå Pas d'alerte au salari√© sur les jours r√©int√©gr√©s
- ‚ùå Pas d'email de confirmation
- ‚ùå Pas d'historique visible

#### 4. Pas de Validation √† la Pose
- ‚ùå On ne v√©rifie pas si le salari√© a assez de jours disponibles
- ‚ùå On peut poser plus de CA que disponible

---

## R√©percussions pour le Salari√©

### Sc√©nario 1 : SANS R√©int√©gration (Situation actuelle) ‚ùå

```
Janvier :
- Pose 10 jours CA (solde : 25 ‚Üí 15)
- AM interrompt 4 jours CA
- Solde reste √† 15 ‚Üê PROBL√àME : perte de 4 jours !

Impact sur l'ann√©e :
- Salari√© perd d√©finitivement 4 jours de cong√©s
- Non-conformit√© l√©gale
- Risque contentieux prud'homal
```

### Sc√©nario 2 : AVEC R√©int√©gration (Conforme) ‚úÖ

```
Janvier :
- Pose 10 jours CA (solde : 25 ‚Üí 15)
- AM interrompt 4 jours CA
- R√©int√©gration automatique (solde : 15 ‚Üí 19) ‚úÖ
- Notification au salari√© : "4 jours de CA r√©int√©gr√©s suite √† arr√™t maladie"

Impact sur l'ann√©e :
- Salari√© conserve tous ses droits
- Conformit√© l√©gale
- Transparence totale
```

---

## Impact Multi-Types d'Absence

### Types Concern√©s par la R√©int√©gration

**Doivent √™tre r√©int√©gr√©s quand interrompus** :
- ‚úÖ CA (Cong√©s Annuels)
- ‚úÖ CP (Cong√©s Pay√©s)
- ‚úÖ CT (Cong√©s Trimestriels)
- ‚úÖ RTT
- ‚úÖ REC (R√©cup√©ration)
- ‚úÖ CEX (Cong√© exceptionnel)

**Ne sont PAS r√©int√©gr√©s** (absences non d√©compt√©es) :
- ‚è∏Ô∏è TEL (T√©l√©travail) - pas de compteur
- ‚è∏Ô∏è DEL (D√©l√©gation) - compteur horaire s√©par√©
- ‚è∏Ô∏è FO (Formation) - obligation employeur

---

## Solution Requise

### Architecture Compl√®te

#### 1. Backend - Mod√®le de Donn√©es

```python
# Nouveau mod√®le dans server.py
class EmployeeLeaveBalance(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    employee_id: str
    year: int
    
    # Soldes par type
    ca_initial: float = 25.0      # Cong√©s annuels (ex: 25 jours/an)
    ca_taken: float = 0.0          # CA consomm√©s
    ca_reintegrated: float = 0.0   # CA r√©int√©gr√©s apr√®s interruption
    ca_balance: float = 25.0       # Solde disponible
    
    rtt_initial: float = 12.0      # RTT (ex: 12 jours/an)
    rtt_taken: float = 0.0
    rtt_reintegrated: float = 0.0
    rtt_balance: float = 12.0
    
    rec_balance: float = 0.0       # R√©cup√©ration (accumulation variable)
    
    ct_balance: float = 0.0        # Cong√©s trimestriels
    
    # Historique
    last_updated: datetime
    
class LeaveTransaction(BaseModel):
    """Historique des mouvements de compteurs"""
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    employee_id: str
    transaction_date: datetime
    leave_type: str                # CA, RTT, REC, etc.
    
    operation: str                 # "deduct" (pose), "reintegrate" (r√©int√©gration), "grant" (attribution)
    amount: float                  # Nombre de jours
    
    reason: str                    # Ex: "Maladie du 05/01 au 10/01"
    related_absence_id: Optional[str] = None
    
    balance_before: float
    balance_after: float
```

#### 2. Backend - API Endpoints

```python
@api_router.get("/leave-balance/{employee_id}")
async def get_leave_balance(employee_id: str):
    """R√©cup√®re les soldes actuels d'un employ√©"""
    pass

@api_router.post("/leave-balance/deduct")
async def deduct_leave(employee_id: str, leave_type: str, days: float):
    """D√©compte des jours lors de la pose d'absence"""
    # V√©rifie le solde disponible
    # D√©duit les jours
    # Cr√©e une transaction
    pass

@api_router.post("/leave-balance/reintegrate")
async def reintegrate_leave(employee_id: str, leave_type: str, days: float, reason: str):
    """R√©int√®gre des jours suite √† interruption"""
    # Ajoute les jours au solde
    # Cr√©e une transaction avec raison
    # Envoie notification
    pass

@api_router.get("/leave-transactions/{employee_id}")
async def get_leave_history(employee_id: str):
    """R√©cup√®re l'historique des mouvements"""
    pass
```

#### 3. Frontend - Logique de R√©int√©gration

```javascript
// Dans MonthlyPlanningFinal.js
const handleAbsenceReplacement = async (employee, day, oldType, newType) => {
  // 1. D√©terminer si oldType doit √™tre r√©int√©gr√©
  const shouldReintegrate = ['CA', 'CP', 'CT', 'RTT', 'REC', 'CEX'].includes(oldType);
  
  if (shouldReintegrate) {
    // 2. Calculer le nombre de jours √† r√©int√©grer
    const daysToReintegrate = 1; // ou calcul plus complexe
    
    // 3. Appeler API de r√©int√©gration
    await fetch(`${API_URL}/api/leave-balance/reintegrate`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({
        employee_id: employee.id,
        leave_type: oldType,
        days: daysToReintegrate,
        reason: `Interrompu par ${newType} le ${day}`
      })
    });
    
    // 4. Afficher notification
    showNotification({
      type: 'info',
      message: `${employee.name} : ${daysToReintegrate} jour(s) de ${oldType} r√©int√©gr√©(s)`
    });
  }
};
```

#### 4. Frontend - Affichage des Soldes

```javascript
// Nouveau composant LeaveBalanceWidget.js
const LeaveBalanceWidget = ({ employee }) => {
  return (
    <div className="bg-white rounded-lg shadow p-4">
      <h3 className="font-bold mb-3">Soldes de Cong√©s</h3>
      <div className="space-y-2">
        <div className="flex justify-between">
          <span>Cong√©s Annuels (CA)</span>
          <span className="font-bold">{employee.ca_balance} jours</span>
        </div>
        <div className="flex justify-between">
          <span>RTT</span>
          <span className="font-bold">{employee.rtt_balance} jours</span>
        </div>
        <div className="flex justify-between">
          <span>R√©cup√©ration</span>
          <span className="font-bold">{employee.rec_balance} jours</span>
        </div>
      </div>
      
      {employee.ca_reintegrated > 0 && (
        <div className="mt-3 p-2 bg-green-50 border border-green-200 rounded">
          <p className="text-sm text-green-800">
            ‚úÖ {employee.ca_reintegrated} jour(s) r√©int√©gr√©(s) cette ann√©e
          </p>
        </div>
      )}
    </div>
  );
};
```

#### 5. Notifications

```javascript
// Service de notification
const notifyLeaveReintegration = async (employee, details) => {
  // Email au salari√©
  await sendEmail({
    to: employee.email,
    subject: 'R√©int√©gration de jours de cong√©s',
    template: 'leave_reintegration',
    data: {
      employee_name: employee.name,
      leave_type: details.leave_type,
      days_reintegrated: details.days,
      reason: details.reason,
      new_balance: details.new_balance
    }
  });
  
  // Notification dans l'app
  await createNotification({
    user_id: employee.id,
    type: 'leave_reintegration',
    message: `${details.days} jour(s) de ${details.leave_type} r√©int√©gr√©(s)`,
    read: false
  });
};
```

---

## Workflow Complet

### Cas : Arr√™t Maladie pendant Cong√©s

```
1. Import Excel : CA du 01/01 au 14/01 (10 jours)
   ‚îî‚îÄ> API : POST /leave-balance/deduct
       ‚îî‚îÄ> Solde CA : 25 ‚Üí 15 jours
       ‚îî‚îÄ> Transaction cr√©√©e : "Pose CA 01-14/01 : -10j"

2. Import Excel : AM du 05/01 au 10/01 (6 jours)
   ‚îî‚îÄ> Planning : D√©tecte remplacement de 4 jours ouvrables de CA
       ‚îî‚îÄ> API : POST /leave-balance/reintegrate
           ‚îî‚îÄ> Solde CA : 15 ‚Üí 19 jours
           ‚îî‚îÄ> Transaction cr√©√©e : "R√©int√©gration CA suite AM 05-10/01 : +4j"
       ‚îî‚îÄ> Notification : Email + notification in-app
       ‚îî‚îÄ> Log : "‚ö†Ô∏è Jean Dupont : 4 jours CA r√©int√©gr√©s suite √† maladie"

3. Affichage Mon Espace :
   ‚îî‚îÄ> Widget Soldes : "CA : 19 jours disponibles"
   ‚îî‚îÄ> Badge : "‚úÖ 4 jour(s) r√©int√©gr√©(s) cette ann√©e"
   ‚îî‚îÄ> Historique : Liste des transactions
```

---

## Priorit√© d'Impl√©mentation

### Phase 1 : Backend (CRITIQUE)
1. Cr√©er mod√®les `EmployeeLeaveBalance` et `LeaveTransaction`
2. Cr√©er endpoints API
3. Migration donn√©es : initialiser soldes pour tous les employ√©s

### Phase 2 : Logique de R√©int√©gration
4. D√©tecter les remplacements dans planning
5. Appeler API de r√©int√©gration automatiquement
6. Logger les op√©rations

### Phase 3 : Frontend Affichage
7. Widget soldes dans Mon Espace
8. Historique des transactions
9. Badges de r√©int√©gration

### Phase 4 : Notifications
10. Emails automatiques
11. Notifications in-app
12. Alertes managers

---

## Estimation Temps

- **Phase 1** : 2-3h (backend + API)
- **Phase 2** : 1-2h (logique r√©int√©gration)
- **Phase 3** : 2h (frontend affichage)
- **Phase 4** : 1h (notifications)

**TOTAL** : 6-8h de d√©veloppement

---

## Risques si Non Impl√©ment√©

### Risques L√©gaux
- ‚öñÔ∏è Non-conformit√© Code du Travail
- ‚öñÔ∏è Contentieux prud'homaux
- ‚öñÔ∏è Amendes inspection du travail

### Risques Op√©rationnels
- üìâ Perte de confiance des salari√©s
- üìâ Erreurs de comptabilit√© RH
- üìâ Litiges internes

### Risques Financiers
- üí∞ Indemnisation des jours perdus
- üí∞ Frais contentieux
- üí∞ Corrections manuelles chronophages

---

## Recommandation

üö® **CRITIQUE** : Cette fonctionnalit√© est OBLIGATOIRE pour la conformit√© l√©gale.

**Plan d'action** :
1. ‚úÖ Tester d'abord les priorit√©s visuelles (Option A)
2. ‚ö†Ô∏è Impl√©menter ENSUITE le syst√®me de compteurs (PRIORITAIRE)
3. ‚úÖ Puis continuer avec B, C, D

---

## Date
Date : 2025-01-12
Statut : ANALYSE COMPL√âT√âE - Impl√©mentation requise
Priorit√© : CRITIQUE
